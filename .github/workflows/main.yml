name: MLOps Pipeline CI/CD

# Trigger the workflow on push to main and pull requests
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      # ============================================
      # STAGE 1: Environment Setup
      # ============================================
      - name: "Stage 1: Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "Stage 1: Set up Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: "Stage 1: Display Python Version"
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
      
      - name: "Stage 1: Install Dependencies"
        run: |
          echo "Installing dependencies from requirements.txt..."
          pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "Dependencies installed successfully!"
          else
            echo "requirements.txt not found!"
            exit 1
          fi
      
      # ============================================
      # STAGE 2: Pipeline Compilation
      # ============================================
      - name: "Stage 2: Validate Python Syntax"
        run: |
          echo "Validating Python files..."
          python -m py_compile src/pipeline_components.py
          python -m py_compile pipeline.py
          echo "âœ“ Python syntax validation passed!"
      
      - name: "Stage 2: Compile Pipeline to YAML"
        run: python compile_pipeline.py
      
      - name: "Stage 2: Pipeline Compilation - Verify pipeline.yaml"
        run: |
          echo "Verifying pipeline.yaml was generated..."
          if [ -f pipeline.yaml ]; then
            echo "âœ“ pipeline.yaml generated successfully"
            echo "File size: $(wc -c < pipeline.yaml) bytes"
            echo "File lines: $(wc -l < pipeline.yaml) lines"
            echo ""
            echo "First 20 lines of pipeline.yaml:"
            head -20 pipeline.yaml
          else
            echo "âœ— ERROR: pipeline.yaml was not generated!"
            exit 1
          fi
      
      # ============================================
      # STAGE 3: Validation & Testing
      # ============================================
      - name: "Stage 3: Verify pipeline.yaml"
        run: |
          if [ -f pipeline.yaml ]; then
            echo "âœ“ pipeline.yaml verified"
            echo "File size: $(wc -c < pipeline.yaml) bytes"
            echo "Line count: $(wc -l < pipeline.yaml) lines"
          else
            echo "âœ— ERROR: pipeline.yaml not found!"
            exit 1
          fi
      
      # ============================================
      # UPLOAD ARTIFACTS
      # ============================================
      - name: "Upload pipeline.yaml as Artifact"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-yaml-py${{ matrix.python-version }}
          path: pipeline.yaml
          retention-days: 30
      
      - name: "Upload Source Code as Artifact"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: source-code-py${{ matrix.python-version }}
          path: |
            pipeline.py
            src/
            requirements.txt
            compile_pipeline.py
          retention-days: 30
      
      # ============================================
      # SUCCESS SUMMARY
      # ============================================
      - name: "Workflow Success Summary"
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "âœ“ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
          echo "=========================================="
          echo ""
          echo "âœ“ Stage 1: Environment Setup - PASSED"
          echo "  - Checked out code from GitHub"
          echo "  - Set up Python ${{ matrix.python-version }}"
          echo "  - Installed all dependencies"
          echo ""
          echo "âœ“ Stage 2: Pipeline Compilation - PASSED"
          echo "  - Validated Python syntax"
          echo "  - Compiled pipeline.py â†’ pipeline.yaml"
          echo ""
          echo "âœ“ Stage 3: Validation & Testing - PASSED"
          echo "  - Verified pipeline.yaml output"
          echo ""
          echo "ðŸ“¦ Artifacts Generated:"
          echo "  - pipeline.yaml (Kubeflow pipeline definition)"
          echo "  - Source code (pipeline.py, components, etc.)"
          echo ""
          echo "=========================================="
